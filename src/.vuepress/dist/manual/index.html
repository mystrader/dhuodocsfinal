<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Instala√ß√£o On Premise | DhuoDocs</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Um poderoso sistema para gerenciar suas APIs">
    <meta name="theme-color" content="#8E3CCB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.80991633.css" as="style"><link rel="preload" href="/assets/js/app.e8dceb60.js" as="script"><link rel="preload" href="/assets/js/2.a347ed34.js" as="script"><link rel="preload" href="/assets/js/20.e8b0308f.js" as="script"><link rel="prefetch" href="/assets/js/10.b6b39271.js"><link rel="prefetch" href="/assets/js/11.75dbce17.js"><link rel="prefetch" href="/assets/js/12.abccc2e6.js"><link rel="prefetch" href="/assets/js/13.6b6fa392.js"><link rel="prefetch" href="/assets/js/14.c4530e4c.js"><link rel="prefetch" href="/assets/js/15.927014ea.js"><link rel="prefetch" href="/assets/js/16.526dc2df.js"><link rel="prefetch" href="/assets/js/17.1dc7c310.js"><link rel="prefetch" href="/assets/js/18.42ba364a.js"><link rel="prefetch" href="/assets/js/19.49831e13.js"><link rel="prefetch" href="/assets/js/21.35d8b9e2.js"><link rel="prefetch" href="/assets/js/22.ba7ebc2f.js"><link rel="prefetch" href="/assets/js/23.f2cd6189.js"><link rel="prefetch" href="/assets/js/3.80700dba.js"><link rel="prefetch" href="/assets/js/4.10668c80.js"><link rel="prefetch" href="/assets/js/5.bd26d954.js"><link rel="prefetch" href="/assets/js/6.6a41b796.js"><link rel="prefetch" href="/assets/js/7.0dd21078.js"><link rel="prefetch" href="/assets/js/8.82f4b19a.js"><link rel="prefetch" href="/assets/js/9.2dd29679.js">
    <link rel="stylesheet" href="/assets/css/0.styles.80991633.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DhuoDocs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/manual/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Manuais
</a></div><div class="nav-item"><a href="/links/" class="nav-link">
  Links
</a></div><div class="nav-item"><a href="https://www.engdb.com.br/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Engineering
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/manual/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  pt-BR
</a></li><li class="dropdown-item"><!----> <a href="/en/manual/" class="nav-link">
  en-US
</a></li></ul></div></div> <a href="https://github.com/mystrader/dhuodocsfinal.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/manual/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Manuais
</a></div><div class="nav-item"><a href="/links/" class="nav-link">
  Links
</a></div><div class="nav-item"><a href="https://www.engdb.com.br/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Engineering
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/manual/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  pt-BR
</a></li><li class="dropdown-item"><!----> <a href="/en/manual/" class="nav-link">
  en-US
</a></li></ul></div></div> <a href="https://github.com/mystrader/dhuodocsfinal.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Manuais</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/manual/" aria-current="page" class="active sidebar-link">Instala√ß√£o On Premise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/manual/#introducao" class="sidebar-link">Introdu√ß√£o üéâ</a></li><li class="sidebar-sub-header"><a href="/manual/#modulos-e-versoes" class="sidebar-link">M√≥dulos e vers√µes</a></li><li class="sidebar-sub-header"><a href="/manual/#repositorios-e-acessos" class="sidebar-link">Reposit√≥rios e acessos</a></li><li class="sidebar-sub-header"><a href="/manual/#pre-requisitos" class="sidebar-link">Pr√©-requisitos</a></li><li class="sidebar-sub-header"><a href="/manual/#azure-ad-b2c" class="sidebar-link">Azure AD B2C</a></li><li class="sidebar-sub-header"><a href="/manual/#instalacao-dhuo" class="sidebar-link">Instala√ß√£o dhuo</a></li></ul></li><li><a href="/manual/adb2cazure.html" class="sidebar-link">AD B2C - Provisionamento Azure</a></li><li><a href="/manual/adb2c.html" class="sidebar-link">AD B2C</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="instalacao-on-premise"><a href="#instalacao-on-premise" class="header-anchor">#</a> Instala√ß√£o On Premise</h1> <p></p><div class="table-of-contents"><ul><li><a href="#introducao-tada">Introdu√ß√£o üéâ</a></li><li><a href="#modulos-e-versoes">M√≥dulos e vers√µes</a></li><li><a href="#repositorios-e-acessos">Reposit√≥rios e acessos</a></li><li><a href="#pre-requisitos">Pr√©-requisitos</a><ul><li><a href="#infraestrutura">Infraestrutura</a></li><li><a href="#ferramentas">Ferramentas</a></li><li><a href="#enderecos-de-dominio">Endere√ßos de dom√≠nio</a></li><li><a href="#google-storage-buckets">Google storage buckets</a></li><li><a href="#google-recaptcha">Google reCAPTCHA</a></li></ul></li><li><a href="#azure-ad-b2c">Azure AD B2C</a></li><li><a href="#instalacao-dhuo">Instala√ß√£o dhuo</a><ul><li><a href="#back-ends">Back-ends</a></li><li><a href="#front-ends">Front-ends</a></li><li><a href="#cms-dhuo-strapi">CMS (dhuo-strapi)</a></li><li><a href="#kong-back-end-gateway">Kong (back-end gateway)</a></li><li><a href="#setup-strapi">Setup strapi</a></li><li><a href="#setup-mongodb">Setup mongodb</a></li></ul></li></ul></div><p></p> <h1 id="dhuo-api-v0-1-0"><a href="#dhuo-api-v0-1-0" class="header-anchor">#</a> DHUO API v0.1.0</h1> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Foi importado do nosso wiki</p></div> <blockquote><p><em>Ei, voc√™ pode adicionar uns √≠cones tamb√©m üéâ</em></p></blockquote> <h2 id="introducao"><a href="#introducao" class="header-anchor">#</a> Introdu√ß√£o üéâ</h2> <p>Este manual cont√©m instru√ß√µes e requisitos para a instala√ß√£o do DHUO API. A vis√£o macro dos componentes do DHUO API pode ser vista abaixo:</p> <p><img src="https://storage.googleapis.com/strapi_prd/dhuo_api_macro_142f5c8cf1/dhuo_api_macro_142f5c8cf1.png" alt="Dhuo API Vis√£o Macro"></p> <h2 id="modulos-e-versoes"><a href="#modulos-e-versoes" class="header-anchor">#</a> M√≥dulos e vers√µes</h2> <p>Os componentes dhuo e suas vers√µes s√£o listados abaixo:</p> <table><thead><tr><th>m√≥dulo</th> <th>vers√£o</th></tr></thead> <tbody><tr><td>apimanagement-accountservice</td> <td>v0.1.0</td></tr> <tr><td>apimanagement-devportal-web</td> <td>v0.1.0</td></tr> <tr><td>apimanagement-healthcheck</td> <td>v0.1.0</td></tr> <tr><td>apimanagement-product</td> <td>v0.1.0</td></tr> <tr><td>apimanagement-schedules</td> <td>v0.1.0</td></tr> <tr><td>apimanagement-service</td> <td>v0.1.0</td></tr> <tr><td>apimanagement-workflow</td> <td>v0.1.0</td></tr> <tr><td>apione-kong</td> <td>v0.1.0</td></tr> <tr><td>dhuo-strapi</td> <td>v0.1.0</td></tr> <tr><td>gdhuo</td> <td>v0.1.0</td></tr> <tr><td>viaapi-service</td> <td>v0.1.0</td></tr> <tr><td>viaapi-web</td> <td>v0.1.0</td></tr></tbody></table> <h2 id="repositorios-e-acessos"><a href="#repositorios-e-acessos" class="header-anchor">#</a> Reposit√≥rios e acessos</h2> <p>As credenciais de acesso ao docker registry e aos arquivos de template devem ser solicitados √† equipe dhuo.</p> <table><thead><tr><th></th> <th>url</th></tr></thead> <tbody><tr><td>docker registry</td> <td>https://registry-dhuo.br.engineering</td></tr> <tr><td>templates de configura√ß√£o</td> <td>https://gitlab.engdb.com.br/apione/dhuoapi-install</td></tr></tbody></table> <h2 id="pre-requisitos"><a href="#pre-requisitos" class="header-anchor">#</a> Pr√©-requisitos</h2> <h3 id="infraestrutura"><a href="#infraestrutura" class="header-anchor">#</a> Infraestrutura</h3> <p>Os requisitos recomendados para os n√≥s do cluster kubernetes s√£o:</p> <table><thead><tr><th>requisito</th></tr></thead> <tbody><tr><td>10vCPU</td></tr> <tr><td>16GB de RAM</td></tr> <tr><td>150GB de disco</td></tr></tbody></table> <p>As vers√µes homologadas dos componentes de infraestrutura necess√°rios para a instala√ß√£o do dhuo s√£o:</p> <table><thead><tr><th></th> <th>vers√£o</th></tr></thead> <tbody><tr><td>grafana</td> <td>7.5.0</td></tr> <tr><td>kafka</td> <td>2.7.0</td></tr> <tr><td>kubernetes</td> <td>v1.20.x</td></tr> <tr><td>mongodb</td> <td>4.6.0</td></tr></tbody></table> <h3 id="ferramentas"><a href="#ferramentas" class="header-anchor">#</a> Ferramentas</h3> <table><thead><tr><th></th> <th>descri√ß√£o</th></tr></thead> <tbody><tr><td>deck</td> <td>usada na configura√ß√£o dos servi√ßos de back-end do dhuo, √© utilizada a ferramenta <strong>decK</strong>. Ela pode ser obtida em https://github.com/Kong/deck.</td></tr> <tr><td>gsutil</td> <td>usada para configura√ß√£o dos buckets no google cloud storage.</td></tr></tbody></table> <h3 id="enderecos-de-dominio"><a href="#enderecos-de-dominio" class="header-anchor">#</a> Endere√ßos de dom√≠nio</h3> <p>√â necess√°rio possuir o cadastro de dom√≠nio para expor o acesso aos seguintes componentes:</p> <table><thead><tr><th>m√≥dulo</th> <th>descri√ß√£o</th></tr></thead> <tbody><tr><td>apimanagement-devportal-web</td> <td>developer portal</td></tr> <tr><td>apione-kong</td> <td>camada de exposi√ß√£o dos servi√ßos back-end consumidos pelos portais</td></tr> <tr><td>dhuo-strapi</td> <td>cms para customiza√ß√£o do developer portal</td></tr> <tr><td>viaapi-web</td> <td>api manager, admin portal</td></tr></tbody></table> <h3 id="google-storage-buckets"><a href="#google-storage-buckets" class="header-anchor">#</a> Google storage buckets</h3> <p>√â necess√°rio possuir dois storage buckets para as seguintes finalidades:</p> <table><thead><tr><th>bucket</th> <th>fun√ß√£o</th></tr></thead> <tbody><tr><td>dhuo-cms</td> <td>armazenamento de imagens utilizadas pelo cms e exibidas no developer portal</td></tr> <tr><td>dhuo-b2c</td> <td>armazenamento dos assets utilizados na customiza√ß√£o do front-end de SSO do Azure AD B2C</td></tr></tbody></table> <p>Ambos os buckets devem possuir acesso p√∫blico. Para isso, adicionar uma permission com as seguintes caracter√≠sticas:</p> <ul><li><strong>Principal:</strong> allUsers</li> <li><strong>Role:</strong> Storage Object Viewer</li></ul> <p>Deve ser habilitado o CORS no bucket dhuo-b2c. Para isso utilize a ferramenta <code>gsutil</code>para carregar as configura√ß√µes de cors presentes no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/gs-buckets" target="_blank" rel="noopener noreferrer">/gs-buckets<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> do reposit√≥rio de templates de configura√ß√£o.</p> <p>Exemplo:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>gsutil cors set cors-config.json gs://dhuo-b2c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="google-recaptcha"><a href="#google-recaptcha" class="header-anchor">#</a> Google reCAPTCHA</h3> <p>Para logins no developer portal √© utilizado o recaptcha. √â necess√°rio gerar um par de chaves de configura√ß√£o do recaptcha do google.</p> <ol><li>Acessar a url https://www.google.com/recaptcha/admin</li> <li>Registrar um novo site correspondente ao dhuo com as seguintes configura√ß√µes:
<strong>Tipo de reCAPTCHA</strong>: reCAPTCHA v2; Caixa de sele√ß√£o &quot;N√£o sou um rob√¥&quot;
<strong>Dom√≠nios:</strong> inserir dois dom√≠nios: b2clogin.com; dom√≠nio do developer portal</li> <li>Obter site key e secret key que ser√£o utilizados nas configura√ß√µes do <strong>AD B2C</strong> e do m√≥dulo dhuo <strong>apimanagement-accountservice</strong>.</li></ol> <h2 id="azure-ad-b2c"><a href="#azure-ad-b2c" class="header-anchor">#</a> Azure AD B2C</h2> <p>Devido ao fato da configura√ß√£o do AD B2C ser realizada majoritariamente somente no setup inicial do ambiente, as instru√ß√µes de provisionamento encontram-se em um manual anexo a esse. Um guia visual complementar tamb√©m est√° dispon√≠vel no reposit√≥rio de templates no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/_visual-guides" target="_blank" rel="noopener noreferrer">/_visual-guides<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p><strong>Aten√ß√£o:</strong> algumas propriedades geradas durante a instala√ß√£o do AD B2C s√£o utilizadas em configura√ß√µes dos outros m√≥dulos dhuo e referenciadas neste manual.</p> <h2 id="instalacao-dhuo"><a href="#instalacao-dhuo" class="header-anchor">#</a> Instala√ß√£o dhuo</h2> <h3 id="back-ends"><a href="#back-ends" class="header-anchor">#</a> Back-ends</h3> <p>Passos referentes aos m√≥dulos:</p> <table><thead><tr><th>m√≥dulo dhuo</th></tr></thead> <tbody><tr><td>apimanagement-accountservice</td></tr> <tr><td>apimanagement-healthcheck</td></tr> <tr><td>apimanagement-product</td></tr> <tr><td>apimanagement-schedules</td></tr> <tr><td>apimanagement-service</td></tr> <tr><td>apimanagement-workflow</td></tr> <tr><td>viaapi-service</td></tr></tbody></table> <p>Para cada m√≥dulo:</p> <ol><li>Criar um arquivo <strong>application.properties</strong> a partir do modelo presente no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/config" target="_blank" rel="noopener noreferrer">/config<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> do reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o.</li> <li>Configurar as propriedades customizadas (se presentes no arquivo do m√≥dulo em quest√£o) conforme rela√ß√£o abaixo:</li></ol> <table><thead><tr><th>propriedade</th> <th>descri√ß√£o</th> <th>exemplo</th></tr></thead> <tbody><tr><td>app.msgraph.base-identifier-uris</td> <td>dom√≠nio do tenant b2c em formato https://{dominio}. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.PrimaryDomain</a><strong>[1]</strong></td> <td></td></tr> <tr><td>app.msgraph.client-id</td> <td>client ID do app msgraph configurado no tenant do AD B2C. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.app.MsGraph.clientId</a><strong>[1]</strong></td> <td></td></tr> <tr><td>app.msgraph.internal-issuer</td> <td>dom√≠nio do tenant b2c em formato https://{dominio}. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.PrimaryDomain</a><strong>[1]</strong></td> <td></td></tr> <tr><td>app.msgraph.secret</td> <td>client secret  do app msgraph configurado no tenant do AD B2C. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.app.MsGraph.secret</a><strong>[1]</strong></td> <td></td></tr> <tr><td>app.msgraph.service-principal-id</td> <td>Object ID da enterprise application associada ao app apione. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.app.Apione.EnterpriseApplication.objectId</a><strong>[1]</strong></td> <td></td></tr> <tr><td>app.msgraph.tenant</td> <td>Tenant ID do tenant b2c. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.TenantId</a><strong>[1]</strong></td> <td></td></tr> <tr><td>app.recaptcha.secret</td> <td>secret key obtida na configura√ß√£o do Google reCAPTCHA <strong>[1]</strong></td> <td></td></tr> <tr><td>logging.file</td> <td>path para o arquivo de armazenamento de logs</td> <td>INFO</td></tr> <tr><td>logging.level.org.apache.kafka</td> <td>n√≠vel de logs para libs kafka</td> <td>WARN</td></tr> <tr><td>logging.level.org.hibernate</td> <td>n√≠vel de logs do hibernate</td> <td>OFF</td></tr> <tr><td>logging.level.org.springframework</td> <td>n√≠vel de logs gerados pelo spring</td> <td>ERROR</td></tr> <tr><td>logging.level.root</td> <td>n√≠vel de logs gerais da aplica√ß√£o</td> <td>ERROR</td></tr> <tr><td>product.apiManagerUrl</td> <td>url da aplica√ß√£o apimanagement-service para comunica√ß√£o interna entre m√≥dulos <strong>[2]</strong></td> <td>http://apimanagement-service.dhuo:8080</td></tr> <tr><td>product.devPortalUrl</td> <td>url da aplica√ß√£o viaapi-service para comunica√ß√£o interna entre m√≥dulos <strong>[2]</strong></td> <td>http://viaapi-service.dhuo:8080</td></tr> <tr><td>spring.cloud.stream.kafka.binder.brokers</td> <td>url para conex√£o ao broker kafka</td> <td>dhuo-kafka:9092</td></tr> <tr><td>spring.data.mongodb.uri</td> <td>string de conex√£o ao mongodb <strong>[3]</strong></td> <td>mongodb://root:123@dhuo-mongo:27017/dhuo</td></tr></tbody></table> <p>[1] configura√ß√£o presente apenas no m√≥dulo <strong>apimanagement-accountservice</strong>.
[2] configura√ß√£o presente apenas no m√≥dulo <strong>apimanagement-product</strong>.
[3] recomenda-se utilizar o mesmo banco (database) compartilhado entre os m√≥dulos do dhuo. Em futuros releases do produto os m√≥dulos dever√£o ser unificados.</p> <ol start="3"><li>Criar secret do tipo Opaque com nome do m√≥dulo a partir do arquivo application.properties. Exemplo:</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>kubectl create secret generic &lt;m√≥dulo dhuo&gt; --from-file=application.properties -n &lt;namespace&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li><p>Configurar um arquivo <strong>.env</strong> a partir do modelo presente no reposit√≥rio de templates em <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/config/java_opts" target="_blank" rel="noopener noreferrer">/config/java_opts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Ele cont√©m a vari√°vel de ambiente JAVA_OPTS e as configura√ß√µes de inicializa√ß√£o de jvm. <strong>Observa√ß√£o:</strong> a config -Dspring.config.location √© <strong>obrigat√≥ria</strong> na configura√ß√£o de JAVA_OPTS e deve corresponder ao caminho configurado no deployment onde ser√° montado o volume contendo o application.properties criado no configmap do passo anterior.</p></li> <li><p>Criar configmap a partir do arquivo .env. <strong>Observa√ß√£o:</strong> diferente da secret, esse configmap ser√° usado pelo deployment do m√≥dulo como conjunto de vari√°veis de ambiente ao inv√©s de ser mapeada como arquivo. Exemplo:</p></li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl create configmap <span class="token operator">&lt;</span>m√≥dulo dhuo<span class="token operator">&gt;</span>-vars -n <span class="token operator">&lt;</span>namespace<span class="token operator">&gt;</span> --from-env-file<span class="token operator">=</span>.env
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="6"><li><p>Configurar arquivos template de objetos kubernetes (deployment.yaml, service.yaml, hpa.yaml) a partir dos modelos presentes no reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/k8s" target="_blank" rel="noopener noreferrer">/k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. <strong>Observa√ß√£o:</strong> tais arquivos s√£o modelos de refer√™ncia e podem ser customizados com outras propriedades al√©m das existentes conforme necessidade.</p></li> <li><p>Realizar deploy dos objetos kubernetes no cluster a partir dos arquivos de configura√ß√£o do passo anterior. Exemplo:</p></li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl apply -f <span class="token operator">&lt;</span>diret√≥rio<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Passos referentes aos m√≥dulos</p> <table><thead><tr><th>m√≥dulo dhuo</th></tr></thead> <tbody><tr><td>gdhuo</td></tr></tbody></table> <ol><li>Criar e configurar um arquivo <strong>.env</strong> a partir do modelo presente no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/config" target="_blank" rel="noopener noreferrer">/config<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> do reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o. As vari√°veis configur√°veis est√£o relacionadas abaixo:</li></ol> <table><thead><tr><th>vari√°vel</th> <th>descri√ß√£o</th> <th>exemplo</th></tr></thead> <tbody><tr><td>MONGODB_DATABASE</td> <td>database do dhuo no mongodb</td> <td>dhuo</td></tr> <tr><td>MONGODB_OPTIONS</td> <td>Op√ß√µes extras de configura√ß√£o da conex√£o ao mongodb.</td> <td>authSource=admin&amp;gssapiServiceName=mongodb</td></tr> <tr><td>MONGODB_PASSWORD</td> <td>senha do usu√°rio de acesso ao mongodb</td> <td>123</td></tr> <tr><td>MONGODB_URI</td> <td>hosts de conex√£o ao mongodb no formato host:port. Caso haja mais de um, separar por v√≠rgulas.</td> <td>dhuo-mongo-1:27017,dhuo-mongo-mongodb-2:27017</td></tr> <tr><td>MONGODB_USERNAME</td> <td>usu√°rio de conex√£o ao mongodb</td> <td>root</td></tr></tbody></table> <ol start="2"><li>Criar secret do tipo Opaque com nome do m√≥dulo a partir do arquivo .env. <strong>Observa√ß√£o:</strong> diferente dos m√≥dulos anteriores, essa secret ser√° usada pelo deployment do m√≥dulo como conjunto de vari√°veis de ambiente ao inv√©s de ser mapeada como arquivo. Exemplo:</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl create secret generic gdhuo --from-env-file<span class="token operator">=</span>.env -n <span class="token operator">&lt;</span>namespace<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li><p>Configurar arquivos template de objetos kubernetes (deployment.yaml, service.yaml, hpa.yaml) a partir dos modelos presentes no reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/k8s" target="_blank" rel="noopener noreferrer">/k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. <strong>Observa√ß√£o:</strong> tais arquivos s√£o modelos de refer√™ncia e podem ser customizados com outras propriedades al√©m das existentes conforme necessidade.</p></li> <li><p>Realizar deploy dos objetos kubernetes no cluster a partir dos arquivos de configura√ß√£o do passo anterior. Exemplo:</p></li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl apply -f <span class="token operator">&lt;</span>diret√≥rio<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="front-ends"><a href="#front-ends" class="header-anchor">#</a> Front-ends</h3> <p>Passos referentes aos m√≥dulos</p> <table><thead><tr><th>m√≥dulo dhuo</th></tr></thead> <tbody><tr><td>apimanagement-devportal-web</td></tr> <tr><td>viaapi-web</td></tr></tbody></table> <ol><li>Criar e configurar um arquivo <strong>.env</strong> a partir do modelo presente no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/config" target="_blank" rel="noopener noreferrer">/config<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> do reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o. As vari√°veis configur√°veis est√£o relacionadas abaixo:</li></ol> <p><strong>apimanagement-devportal-web</strong></p> <table><thead><tr><th>vari√°vel</th> <th>descri√ß√£o</th> <th>exemplo</th></tr></thead> <tbody><tr><td>AUTH_CLIENT_ID</td> <td>o Client ID do app apimanagement-devportal-web configurado no tenant b2c. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.app.Devportalweb.clientId</a></td> <td>11111111-1111-1111-1111-111111111111</td></tr> <tr><td>AUTH_CLIENT_SECRET</td> <td>deixar vazio</td> <td></td></tr> <tr><td>AUTH_SCOPES</td> <td>url do tenant b2c para acesso aos escopos no formato https://{tenant b2c}.onmicrosoft.com/apione/access offline_access openid. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.Name</a></td> <td>https://b2c-exmaple.onmicrosoft.com/apione/access offline_access openid</td></tr> <tr><td>AUTH_TENANT_NAME</td> <td>nome do tenant b2c. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.Name</a></td> <td>b2c-example</td></tr> <tr><td>IMAGES_DOMAIN</td> <td>url de acesso ao bucket do cms no google storage</td> <td>storage.googleapis.com/dhuo-cms</td></tr> <tr><td>NEXT_PUBLIC_APIMANAGEMENT_API_URL</td> <td>url de acesso ao back-end da aplica√ß√£o dhuo no formato {host}/it-management/</td> <td>https://gateway-dhuo.br.engineering/it-management/</td></tr> <tr><td>NEXT_PUBLIC_AUTH_PASS_CHANGE</td> <td>policy do ad b2c. Valor fixo.</td> <td>B2C_1A_VV_PassChange</td></tr> <tr><td>NEXT_PUBLIC_AUTH_PROFILE_EDIT_PROVIDER</td> <td>policy do ad b2c. Valor fixo.</td> <td>B2C_1A_VV_ProfileEdit-Native</td></tr> <tr><td>NEXT_PUBLIC_AUTH_SU_PROVIDER</td> <td>policy do ad b2c. Valor fixo.</td> <td>B2C_1A_VV_EXT_SU</td></tr> <tr><td>NEXT_PUBLIC_AUTH_SUSI_PROVIDER</td> <td>policy do ad b2c. Valor fixo.</td> <td>B2C_1A_VV_EXT_SUSI</td></tr> <tr><td>NEXT_PUBLIC_ENVIRONMENT</td> <td>valor fixo</td> <td>SIT</td></tr> <tr><td>NEXT_PUBLIC_PORTAL_NAME</td> <td>nome do developer portal a ser criado no dhuo</td> <td>marketplace</td></tr> <tr><td>NEXT_PUBLIC_STRAPI_API_URL</td> <td>url de acesso ao cms.</td> <td>https://strapi-dhuo.com.br/</td></tr> <tr><td>NEXTAUTH_URL</td> <td>url do developer portal</td> <td>https://devportal-dhuo.br.engineering</td></tr></tbody></table> <p><strong>viaapi-web</strong></p> <table><thead><tr><th>vari√°vel</th> <th>descri√ß√£o</th> <th>exemplo</th></tr></thead> <tbody><tr><td>API_URL</td> <td>url de acesso ao back-end da aplica√ß√£o dhuo no formato {host}/it-management.</td> <td>https://gateway-dhuo.com.br/it-management</td></tr> <tr><td>AUTHORITY</td> <td>url da policy de login do ad b2c no formato https://{tenant b2c}.b2clogin.com/{tenant b2c}.onmicrosoft.com/B2C_1A_VV_SUSI (fixo). Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.Name</a></td> <td>https://b2c-example.b2clogin.com/b2c-example.onmicrosoft.com/B2C_1A_VV_SUSI</td></tr> <tr><td>CLIENT_ID</td> <td>o Client ID do app viaapi-web configurado no tenant b2c. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.app.Viaapiweb.clientId</a></td> <td>11111111-1111-1111-1111-111111111111</td></tr> <tr><td>DEFAULT_LANGUAGE</td> <td>idioma padr√£o do portal admin. Valores poss√≠veis pt-BR, en-US</td> <td>pt-BR</td></tr> <tr><td>KNOWN_AUTHORITIES</td> <td>dom√≠nio do ad b2c no formato {tenant b2c}.b2clogin.com. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.Name</a></td> <td>b2c-example.b2clogin.com</td></tr> <tr><td>POSTLOGOUT_REDIRECTURI</td> <td>url de redirecionamento ap√≥s logout do portal.</td> <td>/</td></tr> <tr><td>SCOPES</td> <td>url para acesso aos escopos da aplica√ß√£o no formato https://{tenant b2c}.onmicrosoft.com/apione/access. Vide propriedade <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.Name</a></td> <td>https://kenissonb2c.onmicrosoft.com/apione/access</td></tr></tbody></table> <ol start="2"><li>Criar configmap do tipo Opaque com nome do m√≥dulo a partir do arquivo .env. Exemplo:</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl create configmap generic <span class="token operator">&lt;</span>m√≥dulo dhuo<span class="token operator">&gt;</span> --from-env-file<span class="token operator">=</span>.env -n <span class="token operator">&lt;</span>namespace<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li><p>Configurar arquivos template de objetos kubernetes (deployment.yaml, service.yaml, hpa.yaml) a partir dos modelos presentes no reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/k8s" target="_blank" rel="noopener noreferrer">/k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. <strong>Observa√ß√£o:</strong> tais arquivos s√£o modelos de refer√™ncia e podem ser customizados com outras propriedades al√©m das existentes conforme necessidade.</p></li> <li><p>Realizar deploy dos objetos kubernetes no cluster a partir dos arquivos de configura√ß√£o do passo anterior. Exemplo:</p></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>kubectl apply -f &lt;diret√≥rio&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="cms-dhuo-strapi"><a href="#cms-dhuo-strapi" class="header-anchor">#</a> CMS (dhuo-strapi)</h3> <ol><li>Criar e configurar um arquivo <strong>.env</strong> a partir do modelo presente no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/config" target="_blank" rel="noopener noreferrer">/config<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> do reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o. As vari√°veis configur√°veis est√£o relacionadas abaixo:</li></ol> <table><thead><tr><th>vari√°vel</th> <th>descri√ß√£o</th> <th>exemplo</th></tr></thead> <tbody><tr><td>DATABASE_NAME</td> <td>database do cms no mongodb</td> <td>strapi</td></tr> <tr><td>DATABASE_HOST</td> <td>hosts de conex√£o ao mongodb. Caso haja mais de um, separar por v√≠rgulas.</td> <td>dhuo-mongo-1,dhuo-mongo-mongodb-2</td></tr> <tr><td>DATABASE_PASSWORD</td> <td>senha do usu√°rio de acesso ao mongodb</td> <td>123</td></tr> <tr><td>DATABASE_PORT</td> <td>porta da conex√£o com o mongodb</td> <td>27017</td></tr> <tr><td>DATABASE_USERNAME</td> <td>usu√°rio de conex√£o ao mongodb</td> <td>root</td></tr> <tr><td>STORAGE_ACCOUNT_NAME</td> <td>nome do bucket do google storage a ser utilizado pelo cms</td> <td>dhuo-cms</td></tr> <tr><td>STORAGE_BASE_URL</td> <td>url de acesso ao bucket do cms no google storage</td> <td>https://storage.googleapis.com/dhuo-cms</td></tr></tbody></table> <ol start="2"><li>Criar secret do tipo Opaque com nome do m√≥dulo a partir do arquivo .env. Exemplo:</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl create secret generic dhuo-strapi --from-env-file<span class="token operator">=</span>.env -n <span class="token operator">&lt;</span>namespace<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li><p>Configurar arquivos template de objetos kubernetes (deployment.yaml, service.yaml, hpa.yaml) a partir dos modelos presentes no reposit√≥rio de templates de configura√ß√£o do m√≥dulo em quest√£o no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/k8s" target="_blank" rel="noopener noreferrer">/k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. <strong>Observa√ß√£o:</strong> tais arquivos s√£o modelos de refer√™ncia e podem ser customizados com outras propriedades al√©m das existentes conforme necessidade.</p></li> <li><p>Realizar deploy dos objetos kubernetes no cluster a partir dos arquivos de configura√ß√£o do passo anterior. Exemplo:</p></li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl apply -f <span class="token operator">&lt;</span>diret√≥rio<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="kong-back-end-gateway"><a href="#kong-back-end-gateway" class="header-anchor">#</a> Kong (back-end gateway)</h3> <p><strong>Gerar JWT</strong></p> <p>√â necess√°rio gerar uma chave rsa no formato pem a partir do jwk gerado no AD B2C. Para isso:</p> <ol><li>Acessar a configura√ß√£o de openid gerada pelo tenant b2c em https://{tenant b2c}.b2clogin.com/{tenant b2c}.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=B2C_1A_VV_SUSI</li> <li>Acessar a url definida na propriedade <strong>jwks_uri</strong></li> <li>Gerar um arquivo .pem a partir do jwt definido na propriedade <strong>keys</strong>.</li></ol> <p>Ferramentas para convers√£o jwk-pem:</p> <ul><li>https://github.com/lffranca/openid</li> <li>https://www.npmjs.com/package/jwk-to-pem</li></ul> <p><strong>Gerar Basic Auth</strong></p> <p>Essas propriedades s√£o cadastradas no AD B2C. Vide propriedades <a href="/Manual-de-Instala%C3%A7%C3%A3o-On-Premise-DHUO/AD-B2C-%2D-Provisionamento-Azure">b2cTenant.PolicyKeys.RestApiUsername e b2cTenant.PolicyKeys.RestApiPassword</a>.</p> <p><strong>Deploy kong</strong></p> <p>Para configura√ß√£o dos servi√ßos de back-end do dhuo,</p> <ol><li>Utilize a vers√£o atual do m√≥dulo <code>apione-kong</code></li> <li>Configure os certificados e consumers do kong presentes no arquivo , conforme rela√ß√£o a abaixo:</li></ol> <table><thead><tr><th>propriedade</th> <th>descri√ß√£o</th></tr></thead> <tbody><tr><td>consumers &gt; jwt_secrets &gt; key</td> <td>valor da propriedade <strong>kid</strong> obtida no passo Gerar JWT</td></tr> <tr><td>consumers &gt; jwt_secrets &gt; rsa_public_key</td> <td>arquivo .pem gerado a partir do jwk no passo Gerar JWT</td></tr> <tr><td>consumers &gt; basicauth_credentials &gt; password</td> <td>propriedade b2cTenant.PolicyKeys.RestApiPassword no passo Gerar Basic Auth</td></tr> <tr><td>consumers &gt; basicauth_credentials &gt; username</td> <td>propriedade b2cTenant.PolicyKeys.RestApiUsername no passo Gerar Basic Auth</td></tr></tbody></table> <ol start="3"><li><p>Caso necess√°rio, altere o valor do campo <strong>host</strong> de cada service no arquivo dhuo.yaml presente no diret√≥rio <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/kong" target="_blank" rel="noopener noreferrer">/kong<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> para corresponder ao host de instala√ß√£o de cada m√≥dulo.</p></li> <li><p>Utilizando a ferramenta <code>decK</code>, realize a importa√ß√£o das configura√ß√µes do arquivo dhuo.yaml para a inst√¢ncia kong onde os servi√ßos do dhuo ser√£o expostos.</p></li></ol> <p>Exemplo:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>deck <span class="token function">sync</span> --kong-addr <span class="token operator">&lt;</span>konghost<span class="token operator">&gt;</span>:8001 --state dhuo.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="setup-strapi"><a href="#setup-strapi" class="header-anchor">#</a> Setup strapi</h3> <p>Ap√≥s deploy do m√≥dulo <strong>dhuo-strapi</strong>,</p> <ol><li>Realize o primeiro acesso √† intereface do strapi em {url-strapi}/admin</li> <li>Cadastre o usu√°rio administrador</li> <li>Configure as permiss√µes de acesso √† api do cms acessando: Settings &gt; USERS &amp; PERMISSIONS PLUGIN &gt; Roles</li></ol> <video width="800" height="600" controls="controls"><source src="https://user-images.githubusercontent.com/191412/138390972-c558b850-b8d3-4acb-b9f3-058649826429.mp4" type="video/mp4">  
Your browser does not support the video tag.
</video> <ol start="4"><li>Editar a role <strong>Public</strong></li> <li>Ativar as permiss√µes conforme tabelas abaixo:</li> <li>Ap√≥s selecionar as permiss√µes, clicar no bot√£o salvar, no topo da p√°gina</li></ol> <p><strong>APPLICATION</strong></p> <table><thead><tr><th>Categoria</th> <th>Permiss√µes</th></tr></thead> <tbody><tr><td>FONT</td> <td>count, find, findone</td></tr> <tr><td>PORTAL</td> <td>count, find, findone</td></tr> <tr><td>PORTAL-CATALOG</td> <td>count, find, findone</td></tr> <tr><td>PORTAL-HOME</td> <td>count, find, findone</td></tr> <tr><td>PORTAL-MENU</td> <td>count, find, findone</td></tr> <tr><td>PORTAL-PAGE</td> <td>count, find, findone</td></tr> <tr><td>PORTAL-THEME</td> <td>count, find, findone</td></tr> <tr><td>STYLE</td> <td>count, find, findone</td></tr></tbody></table> <p><strong>CONTENT-MANAGER</strong></p> <table><thead><tr><th>Categoria</th> <th>Permiss√µes</th></tr></thead> <tbody><tr><td>COLLECTION-TYPES</td> <td>findone, find, previewmanyrelations</td></tr> <tr><td>COMPONENTS</td> <td>findcomponentconfiguration, findcomponents</td></tr> <tr><td>CONTENT-TYPES</td> <td>findcontenttypeconfiguration, findcontenttypes</td></tr> <tr><td>RELATIONS</td> <td>find</td></tr> <tr><td>SINGLE-TYPES</td> <td>find</td></tr> <tr><td>UID</td> <td>checkuidavailability</td></tr></tbody></table> <p><strong>CONTENT-TYPE-BUILDER</strong></p> <table><thead><tr><th>Categoria</th> <th>Permiss√µes</th></tr></thead> <tbody><tr><td>BUILDER</td> <td>getreservednames</td></tr> <tr><td>COMPONENTS</td> <td>getcomponent, getcomponents</td></tr> <tr><td>CONNECTIONS</td> <td>getconnections</td></tr> <tr><td>CONTENTTYPES</td> <td>getcontenttype, getcontenttypes</td></tr></tbody></table> <p><strong>UPLOAD</strong></p> <table><thead><tr><th>Categoria</th> <th>Permiss√µes</th></tr></thead> <tbody><tr><td>UPLOAD</td> <td>count, find, findone, search</td></tr></tbody></table> <h3 id="setup-mongodb"><a href="#setup-mongodb" class="header-anchor">#</a> Setup mongodb</h3> <p>Ap√≥s deploy dos m√≥dulos de back-end do dhuo</p> <ol><li>Acessar a inst√¢ncia do mongodb</li> <li>Realizar a carga inicial de dados na collection <strong>environment</strong> da database dhuo, com os dados do arquivo <strong>environment.json</strong> presente em <a href="https://gitlab.engdb.com.br/apione/dhuoapi-install/-/tree/master/mongodb" target="_blank" rel="noopener noreferrer">/mongodb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">22/10/2021 10:10:25</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/manual/adb2cazure.html">
        AD B2C - Provisionamento Azure
      </a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e8dceb60.js" defer></script><script src="/assets/js/2.a347ed34.js" defer></script><script src="/assets/js/20.e8b0308f.js" defer></script>
  </body>
</html>
